<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>My Webcrumbs Plugin</title>
        <!-- Markdown support -->
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
        <style>
            @import url(https://fonts.googleapis.com/css2?family=Lato&display=swap);
            @import url(https://fonts.googleapis.com/css2?family=Open+Sans&display=swap);
            @import url(https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200);
        
            /* Custom scrollbar for webkit browsers */
            .custom-scrollbar::-webkit-scrollbar {
                width: 8px;
            }
            .custom-scrollbar::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 10px;
            }
            .custom-scrollbar::-webkit-scrollbar-thumb {
                background: #c5dff8; /* primary-200 */
                border-radius: 10px;
            }
            .custom-scrollbar::-webkit-scrollbar-thumb:hover {
                background: #aad1f4; /* primary-300 */
            }
            #typing-indicator { display: none; }
            
            /* Markdown styling for assistant messages */
            .markdown-content h1, .markdown-content h2, .markdown-content h3 {
                font-weight: bold;
                margin: 0.5em 0;
            }
            .markdown-content h1 { font-size: 1.25em; }
            .markdown-content h2 { font-size: 1.15em; }
            .markdown-content h3 { font-size: 1.1em; }
            .markdown-content p { margin: 0.5em 0; }
            .markdown-content ul, .markdown-content ol { 
                margin: 0.5em 0; 
                padding-left: 1.5em; 
            }
            .markdown-content li { margin: 0.25em 0; }
            .markdown-content code {
                background-color: #f1f5f9;
                padding: 0.125em 0.25em;
                border-radius: 0.25em;
                font-family: 'Courier New', monospace;
                font-size: 0.9em;
            }
            .markdown-content pre {
                background-color: #f1f5f9;
                padding: 1em;
                border-radius: 0.5em;
                overflow-x: auto;
                margin: 0.5em 0;
            }
            .markdown-content pre code {
                background: none;
                padding: 0;
            }
            .markdown-content blockquote {
                border-left: 4px solid #e2e8f0;
                padding-left: 1em;
                margin: 0.5em 0;
                font-style: italic;
            }
            .markdown-content table {
                border-collapse: collapse;
                width: 100%;
                margin: 0.5em 0;
            }
            .markdown-content th, .markdown-content td {
                border: 1px solid #e2e8f0;
                padding: 0.5em;
                text-align: left;
            }
            .markdown-content th {
                background-color: #f8fafc;
                font-weight: bold;
            }
            
            /* Code execution modal styles */
            .modal-overlay {
                backdrop-filter: blur(4px);
            }
            
            .code-textarea {
                font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
                line-height: 1.5;
            }
            
            .execution-button:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
            }
        </style>
    </head>
    <body>
        <div id="webcrumbs">
            <div
                class="w-full min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex flex-col md:flex-row overflow-hidden"
            >
                <div class="w-full md:w-72 lg:w-80 bg-white border-r border-slate-200 flex flex-col shadow-md">
                    <div class="p-6 border-b border-slate-100 hover:bg-slate-50 transition-colors duration-200">
                        <div class="flex items-center space-x-4">
                            <div
                                class="w-12 h-12 bg-gradient-to-r from-primary-500 to-primary-600 rounded-xl flex items-center justify-center shadow-lg shadow-primary-200/40 transform hover:scale-105 transition-all duration-200"
                            >
                                <span class="material-symbols-outlined text-white text-xl">smart_toy</span>
                            </div>
                            <div>
                                <h1 class="font-bold text-xl text-slate-800">BusinessAstra</h1>
                                <p class="text-xs font-medium text-slate-500">AI Assistant</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1 p-5 overflow-y-auto custom-scrollbar">
                        <div class="space-y-2.5">
                            <button
                                id="new-chat-btn"
                                class="w-full flex items-center justify-center space-x-2 px-4 py-3 bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 text-white font-medium rounded-xl transition-all duration-200 transform hover:scale-[1.02] shadow-lg hover:shadow-xl"
                            >
                                <span class="material-symbols-outlined text-white">add</span>
                                <span>New Chat</span>
                            </button>

                        </div>
                    </div>
                    
                    <!-- Chat History Section -->
                    <div class="flex-1 px-5 pb-5">
                        <div class="mb-4 pt-4 border-t border-slate-100">
                            <h3 class="text-sm font-medium text-slate-600">Recent Chats</h3>
                        </div>
                        <div id="chat-history-list" class="space-y-1 max-h-96 overflow-y-auto custom-scrollbar">
                            {% if chat_history %}
                                {% for chat in chat_history[-15:]|reverse %}
                                <div class="chat-item group flex items-center justify-between p-3 rounded-lg hover:bg-slate-50 cursor-pointer transition-all duration-150 {% if current_chat_name and chat.name == current_chat_name %}bg-primary-50 border-l-4 border-primary-500{% endif %}" data-chat-id="{{ chat.id }}">
                                    <div class="flex-1 min-w-0 flex items-center space-x-3">
                                        <span class="material-symbols-outlined text-slate-400 text-sm">chat</span>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm text-slate-700 truncate font-medium">{{ chat.name }}</p>
                                            <p class="text-xs text-slate-500">{{ moment(chat.created_at).fromNow() if moment else 'Recently' }}</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button class="rename-chat-btn p-1.5 text-slate-400 hover:text-slate-600 rounded" data-chat-id="{{ chat.id }}" title="Rename">
                                            <span class="material-symbols-outlined text-sm">edit</span>
                                        </button>
                                        <button class="delete-chat-btn p-1.5 text-slate-400 hover:text-red-600 rounded" data-chat-id="{{ chat.id }}" title="Delete">
                                            <span class="material-symbols-outlined text-sm">delete</span>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-8">
                                    <span class="material-symbols-outlined text-slate-300 text-4xl mb-2 block">chat</span>
                                    <p class="text-sm text-slate-500">No conversations yet</p>
                                    <p class="text-xs text-slate-400 mt-1">Start a new chat to begin</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="p-5 border-t border-slate-100">
                        <div
                            class="flex items-center space-x-3 p-3.5 rounded-xl bg-slate-50 hover:bg-slate-100 transition-all duration-200 cursor-pointer"
                        >
                            <div
                                class="w-10 h-10 bg-gradient-to-r from-primary-500 to-primary-600 rounded-full flex items-center justify-center shadow-md shadow-primary-200/30"
                            >
                                <span class="material-symbols-outlined text-white text-sm">person</span>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-slate-800">{{ username or 'User' }}</p>
                                <p class="text-xs text-slate-500 flex items-center">
                                    <span class="inline-block w-2 h-2 bg-primary-500 rounded-full mr-1.5"></span>
                                    Premium Plan
                                </p>
                            </div>
                            <a
                                href="/logout"
                                class="p-2 text-slate-400 hover:text-red-600 rounded-lg transition-colors duration-200"
                                title="Logout"
                            >
                                <span class="material-symbols-outlined text-lg">logout</span>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="flex-1 flex flex-col max-h-screen overflow-hidden">
                    <div class="bg-white border-b border-slate-200 p-5 flex items-center justify-between shadow-md">
                        <div class="flex items-center space-x-4">
                            <h2 class="text-xl font-semibold text-slate-800">Chat with BusinessAstra</h2>
                            <div
                                class="flex items-center space-x-2 px-3 py-1.5 bg-green-50 rounded-full border border-green-100"
                            >
                                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                <span class="text-xs text-green-700 font-medium">Online</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="relative">
                                <input
                                    type="text"
                                    placeholder="Search conversations..."
                                    class="w-48 md:w-64 pl-10 pr-4 py-2.5 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-200"
                                />
                                <span class="material-symbols-outlined absolute left-3 top-2.5 text-slate-400 text-sm"
                                    >search</span
                                >
                            </div>
                            <button class="p-2.5 hover:bg-slate-100 rounded-lg transition-colors duration-200 group">
                                <span class="material-symbols-outlined text-slate-600 group-hover:text-primary-600"
                                    >more_vert</span
                                >
                            </button>
                        </div>
                    </div>
                    
                    <!-- Current Chat Title -->
                    {% if current_chat_name %}
                    <div class="px-6 py-3 border-b border-slate-100 bg-white">
                        <div class="flex items-center space-x-2">
                            <span class="material-symbols-outlined text-primary-500 text-sm">chat</span>
                            <h2 class="text-sm font-medium text-slate-700">{{ current_chat_name }}</h2>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div id="chat-container" class="flex-1 overflow-y-auto p-6 space-y-8 bg-gradient-to-b from-slate-50 to-white custom-scrollbar">
                        <!-- Initial Welcome Message -->
                        <div id="initial-welcome-message-wrapper" class="flex justify-center">
                            <div
                                class="text-center max-w-md bg-white p-8 rounded-2xl shadow-lg border border-slate-100 transform hover:scale-[1.02] transition-all duration-300"
                            >
                                <div
                                    class="w-20 h-20 bg-gradient-to-r from-primary-500 to-primary-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-primary-200/50"
                                >
                                    <span class="material-symbols-outlined text-white text-3xl">smart_toy</span>
                                </div>
                                <h3 class="text-xl font-semibold text-slate-800 mb-3">Welcome to BusinessAstra</h3>
                                <p class="text-slate-600 text-sm leading-relaxed">
                                    I'm your AI business assistant, ready to help with analytics, strategy, market
                                    research, and more. How can I assist you today?
                                </p>
                            </div>
                        </div>
                        <!-- Initial AI Message with capabilities -->
                        <div id="initial-capabilities-message" class="flex items-start space-x-3">
                            <div
                                class="w-10 h-10 bg-gradient-to-r from-primary-500 to-primary-600 rounded-full flex items-center justify-center flex-shrink-0 shadow-md shadow-primary-200/30"
                            >
                                <span class="material-symbols-outlined text-white text-sm">smart_toy</span>
                            </div>
                            <div
                                class="bg-white p-5 rounded-2xl rounded-tl-sm shadow-md border border-slate-100 max-w-2xl transform hover:shadow-lg transition-all duration-200"
                            >
                                <p class="text-slate-700 leading-relaxed font-medium">
                                    Hello! I'm BusinessAstra, your intelligent business companion. I can help you
                                    with:
                                </p>
                                <ul class="mt-4 space-y-3 grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <li
                                        class="flex items-center space-x-3 p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition-all duration-200"
                                    >
                                        <span
                                            class="material-symbols-outlined text-primary-500 text-lg bg-white p-2 rounded-full shadow-sm"
                                            >analytics</span
                                        >
                                        <span class="text-sm text-slate-700">Business analytics and insights</span>
                                    </li>
                                    <li
                                        class="flex items-center space-x-3 p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition-all duration-200"
                                    >
                                        <span
                                            class="material-symbols-outlined text-primary-500 text-lg bg-white p-2 rounded-full shadow-sm"
                                            >trending_up</span
                                        >
                                        <span class="text-sm text-slate-700">Market research and trends</span>
                                    </li>
                                    <li
                                        class="flex items-center space-x-3 p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition-all duration-200"
                                    >
                                        <span
                                            class="material-symbols-outlined text-primary-500 text-lg bg-white p-2 rounded-full shadow-sm"
                                            >lightbulb</span
                                        >
                                        <span class="text-sm text-slate-700">Strategic planning and advice</span>
                                    </li>
                                    <li
                                        class="flex items-center space-x-3 p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition-all duration-200"
                                    >
                                        <span
                                            class="material-symbols-outlined text-primary-500 text-lg bg-white p-2 rounded-full shadow-sm"
                                            >description</span
                                        >
                                        <span class="text-sm text-slate-700">Document analysis and summaries</span>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <!-- Current Chat Messages -->
                        {% if current_messages %}
                            <script>
                                // Hide initial messages if we have current chat messages
                                document.addEventListener('DOMContentLoaded', function() {
                                    document.getElementById('initial-welcome-message-wrapper').style.display = 'none';
                                    document.getElementById('initial-capabilities-message').style.display = 'none';
                                });
                            </script>
                            {% for message in current_messages %}
                                {% if message.role == 'user' %}
                                    <div class="flex items-start space-x-3 justify-end">
                                        <div class="bg-gradient-to-r from-primary-500 to-primary-600 text-white p-4 rounded-2xl rounded-tr-sm shadow-md max-w-2xl">
                                            <p class="leading-relaxed">{{ message.content | safe }}</p>
                                        </div>
                                        <div class="w-10 h-10 bg-gradient-to-r from-slate-600 to-slate-700 rounded-full flex items-center justify-center flex-shrink-0 shadow-md">
                                            <span class="material-symbols-outlined text-white text-sm">person</span>
                                        </div>
                                    </div>
                                {% elif message.role == 'assistant' %}
                                    <div class="flex items-start space-x-3">
                                        <div class="w-10 h-10 bg-gradient-to-r from-primary-500 to-primary-600 rounded-full flex items-center justify-center flex-shrink-0 shadow-md shadow-primary-200/30">
                                            <span class="material-symbols-outlined text-white text-sm">smart_toy</span>
                                        </div>
                                        <div class="bg-white p-5 rounded-2xl rounded-tl-sm shadow-md border border-slate-100 max-w-2xl">
                                            <div class="prose prose-slate max-w-none">
                                                {{ message.content | safe }}
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% endif %}

                        <!-- Typing indicator (will be cloned and shown/hidden by JS) -->
                        <div id="typing-indicator-template" class="flex items-start space-x-3" style="display: none;">
                            <div
                                class="w-10 h-10 bg-gradient-to-r from-primary-500 to-primary-600 rounded-full flex items-center justify-center flex-shrink-0 shadow-md shadow-primary-200/30"
                            >
                                <span class="material-symbols-outlined text-white text-sm">smart_toy</span>
                            </div>
                            <div
                                class="bg-white p-5 rounded-2xl rounded-tl-sm shadow-md border border-slate-100 max-w-2xl"
                            >
                                <div class="flex space-x-2 items-center">
                                    <div class="w-2.5 h-2.5 bg-primary-500 rounded-full animate-bounce"></div>
                                    <div
                                        class="w-2.5 h-2.5 bg-primary-500 rounded-full animate-bounce [animation-delay:0.2s]"
                                    ></div>
                                    <div
                                        class="w-2.5 h-2.5 bg-primary-500 rounded-full animate-bounce [animation-delay:0.4s]"
                                    ></div>
                                    <span class="ml-2 text-sm text-slate-500 font-medium"
                                        >BusinessAstra is typing...</span
                                    >
                                </div>
                            </div>
                        </div>
                        <!-- Dynamic chat messages will be appended here by JavaScript -->
                    </div>
                    <div class="bg-white border-t border-slate-200 p-5 shadow-lg">
                        <div class="flex items-center space-x-3">
                            <input type="file" id="file-input" class="hidden" accept="*/*" />
                            <button
                                id="attach-file-button"
                                class="p-3 bg-slate-50 hover:bg-slate-100 rounded-full transition-all duration-200 group shadow-sm"
                            >
                                <span
                                    class="material-symbols-outlined text-slate-600 group-hover:text-primary-600 transform group-hover:rotate-12 transition-all duration-200"
                                    >attach_file</span
                                >
                            </button>
                            <button
                                id="code-execute-button"
                                class="p-3 bg-green-50 hover:bg-green-100 rounded-full transition-all duration-200 group shadow-sm"
                                title="Execute Code"
                            >
                                <span
                                    class="material-symbols-outlined text-green-600 group-hover:text-green-700 transform group-hover:scale-110 transition-all duration-200"
                                    >play_arrow</span
                                >
                            </button>
                            <div class="flex-1 relative">
                                <textarea
                                    id="message-input"
                                    placeholder="Type your message here..."
                                    class="w-full p-4 pr-14 border border-slate-200 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent shadow-sm min-h-[60px]"
                                    rows="2"
                                ></textarea>
                                <button
                                    id="send-button"
                                    class="absolute right-3 bottom-3 p-2 bg-primary-500 hover:bg-primary-600 rounded-full transition-all duration-200 group shadow-md"
                                >
                                    <span
                                        class="material-symbols-outlined text-white group-hover:rotate-12 transform transition-all duration-200"
                                        >send</span
                                    >
                                </button>
                            </div>
                            <button
                                class="p-3 bg-slate-50 hover:bg-slate-100 rounded-full transition-all duration-200 group shadow-sm"
                            >
                                <span
                                    class="material-symbols-outlined text-slate-600 group-hover:text-primary-600 transform group-hover:scale-110 transition-all duration-200"
                                    >mic</span
                                >
                            </button>
                        </div>
                        <div
                            class="flex flex-col md:flex-row items-center justify-between mt-4 text-xs text-slate-500 space-y-2 md:space-y-0"
                        >
                            <div class="flex items-center justify-center">
                                <div
                                    class="text-xs text-primary-600 flex items-center space-x-1 px-3 py-1.5 bg-primary-50 rounded-full border border-primary-100"
                                >
                                    <span class="material-symbols-outlined text-xs animate-spin">autorenew</span>
                                    <span class="font-medium">Real-time conversation enabled</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <span>BusinessAstra can make mistakes. Consider checking important information.</span>
                            </div>
                            <div class="flex items-center space-x-2 bg-slate-50 px-3 py-1.5 rounded-lg">
                                <span>Press</span>
                                <kbd class="px-2 py-1 bg-white rounded text-xs shadow-sm border border-slate-200"
                                    >⌘</kbd
                                >
                                <span>/</span>
                                <kbd class="px-2 py-1 bg-white rounded text-xs shadow-sm border border-slate-200"
                                    >Ctrl</kbd
                                >
                                <span>+</span>
                                <kbd class="px-2 py-1 bg-white rounded text-xs shadow-sm border border-slate-200"
                                    >Enter</kbd
                                >
                                <span>to send</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="hidden lg:block">
                    <details class="relative">
                        <summary
                            class="absolute top-5 right-5 p-3 bg-white rounded-full shadow-lg hover:shadow-xl transition-all duration-200 cursor-pointer z-10 transform hover:rotate-12"
                        >
                            <span class="text-primary-600 material-symbols-outlined">menu_book</span>
                        </summary>
                        <div
                            class="absolute top-20 right-5 w-80 bg-white rounded-xl shadow-xl border border-slate-200 p-6 z-20"
                        >
                            <h3 class="font-semibold text-slate-800 mb-5 text-lg">Quick Actions</h3>
                            <div class="space-y-3">
                                <button
                                    class="w-full flex items-center space-x-4 p-4 rounded-xl hover:bg-slate-50 transition-all duration-200 text-left border border-slate-100 shadow-sm hover:shadow-md"
                                >
                                    <span
                                        class="material-symbols-outlined text-primary-500 bg-primary-50 p-2.5 rounded-full"
                                        >upload_file</span
                                    >
                                    <div>
                                        <p class="font-medium text-slate-800">Upload Document</p>
                                        <p class="text-xs text-slate-500 mt-0.5">Analyze files and documents</p>
                                    </div>
                                </button>
                                <button
                                    class="w-full flex items-center space-x-4 p-4 rounded-xl hover:bg-slate-50 transition-all duration-200 text-left border border-slate-100 shadow-sm hover:shadow-md"
                                >
                                    <span
                                        class="material-symbols-outlined text-primary-500 bg-primary-50 p-2.5 rounded-full"
                                        >table_chart</span
                                    >
                                    <div>
                                        <p class="font-medium text-slate-800">Create Report</p>
                                        <p class="text-xs text-slate-500 mt-0.5">Generate business reports</p>
                                    </div>
                                </button>
                                <button
                                    class="w-full flex items-center space-x-4 p-4 rounded-xl hover:bg-slate-50 transition-all duration-200 text-left border border-slate-100 shadow-sm hover:shadow-md"
                                >
                                    <span
                                        class="material-symbols-outlined text-primary-500 bg-primary-50 p-2.5 rounded-full"
                                        >psychology</span
                                    >
                                    <div>
                                        <p class="font-medium text-slate-800">Strategy Session</p>
                                        <p class="text-xs text-slate-500 mt-0.5">Business planning assistance</p>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </details>
                </div>
            </div>
        </div>

        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                // ... (Keep your existing Tailwind config here)
                content: ["./src/**/*.{html,js}", "./templates/**/*.html"], // Added ./templates/**/*.html
                theme: {
                    name: "Custom",
                    fontFamily: {
                        sans: [
                            "Open Sans",
                            "ui-sans-serif",
                            "system-ui",
                            "sans-serif",
                            '"Apple Color Emoji"',
                            '"Segoe UI Emoji"',
                            '"Segoe UI Symbol"',
                            '"Noto Color Emoji"'
                        ]
                    },
                    extend: {
                        fontFamily: {
                            title: [
                                "Lato",
                                "ui-sans-serif",
                                "system-ui",
                                "sans-serif",
                                '"Apple Color Emoji"',
                                '"Segoe UI Emoji"',
                                '"Segoe UI Symbol"',
                                '"Noto Color Emoji"'
                            ],
                            body: [
                                "Open Sans",
                                "ui-sans-serif",
                                "system-ui",
                                "sans-serif",
                                '"Apple Color Emoji"',
                                '"Segoe UI Emoji"',
                                '"Segoe UI Symbol"',
                                '"Noto Color Emoji"'
                            ]
                        },
                        colors: {
                            neutral: {
                                50: "#f7f7f7",
                                100: "#eeeeee",
                                200: "#e0e0e0",
                                300: "#cacaca",
                                400: "#b1b1b1",
                                500: "#999999",
                                600: "#7f7f7f",
                                700: "#676767",
                                800: "#545454",
                                900: "#464646",
                                950: "#282828"
                            },
                            primary: {
                                50: "#f1f7fd",
                                100: "#dfecfa",
                                200: "#c5dff8",
                                300: "#aad1f4",
                                400: "#6faeeb",
                                500: "#4e8fe3",
                                600: "#3973d7",
                                700: "#305fc5",
                                800: "#2d4ea0",
                                900: "#29447f",
                                950: "#1d2b4e",
                                DEFAULT: "#aad1f4"
                            }
                        }
                    },
                    fontSize: {
                        xs: ["12px", {lineHeight: "19.200000000000003px"}],
                        sm: ["14px", {lineHeight: "21px"}],
                        base: ["16px", {lineHeight: "25.6px"}],
                        lg: ["18px", {lineHeight: "27px"}],
                        xl: ["20px", {lineHeight: "28px"}],
                        "2xl": ["24px", {lineHeight: "31.200000000000003px"}],
                        "3xl": ["30px", {lineHeight: "36px"}],
                        "4xl": ["36px", {lineHeight: "41.4px"}],
                        "5xl": ["48px", {lineHeight: "52.800000000000004px"}],
                        "6xl": ["60px", {lineHeight: "66px"}],
                        "7xl": ["72px", {lineHeight: "75.60000000000001px"}],
                        "8xl": ["96px", {lineHeight: "100.80000000000001px"}],
                        "9xl": ["128px", {lineHeight: "134.4px"}]
                    },
                    borderRadius: {
                        none: "0px",
                        sm: "6px",
                        DEFAULT: "12px", // Default for most things
                        md: "12px", // Adjusted to be less than lg
                        lg: "18px", // Message input uses this, previously rounded-xl
                        xl: "24px", // Sidebar user avatar icon
                        "2xl": "48px",
                        "3xl": "72px",
                        full: "9999px"
                    },
                    spacing: {
                        0: "0px",
                        1: "4px",
                        2: "8px",
                        3: "12px",
                        4: "16px",
                        5: "20px",
                        6: "24px",
                        7: "28px",
                        8: "32px",
                        9: "36px",
                        10: "40px",
                        11: "44px",
                        12: "48px",
                        14: "56px",
                        16: "64px",
                        20: "80px",
                        24: "96px",
                        28: "112px",
                        32: "128px",
                        36: "144px",
                        40: "160px",
                        44: "176px",
                        48: "192px",
                        52: "208px",
                        56: "224px",
                        60: "240px",
                        64: "256px",
                        72: "288px",
                        80: "320px",
                        96: "384px",
                        px: "1px",
                        0.5: "2px",
                        1.5: "6px",
                        2.5: "10px",
                        3.5: "14px"
                    }
                },
                plugins: [],
                important: "#webcrumbs"
            }
        </script>
        <script>
            // Client-side JavaScript for chat functionality
            const chatContainer = document.getElementById('chat-container');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const attachFileButton = document.getElementById('attach-file-button');
            const fileInput = document.getElementById('file-input');
            const typingIndicatorTemplate = document.getElementById('typing-indicator-template');
            let typingIndicatorInstance = null;

            // Sidebar buttons
            const newChatButton = document.getElementById('new-chat-btn');

            let initialWelcomeElementHTML = '';
            let initialCapabilitiesElementHTML = '';

            document.addEventListener('DOMContentLoaded', () => {
                const welcomeEl = document.getElementById('initial-welcome-message-wrapper');
                const capabilitiesEl = document.getElementById('initial-capabilities-message');
                if (welcomeEl) initialWelcomeElementHTML = welcomeEl.outerHTML;
                if (capabilitiesEl) initialCapabilitiesElementHTML = capabilitiesEl.outerHTML;
            });


            function escapeHTML(str) {
                if (typeof str !== 'string') return '';
                return str.replace(/[&<>"']/g, function (match) {
                    return {
                        '&': '&',
                        '<': '<',
                        '>': '>',
                        '"': '"',
                        "'": "'",
                    }[match];
                });
            }

            function addMessageToChat(message, sender, isHTML = false) {
                const messageElement = document.createElement('div');
                // Ensure message is a string before processing
                const safeMessage = typeof message === 'string' ? message : String(message);
                
                let content;
                if (isHTML) {
                    content = safeMessage;
                } else if (sender === 'assistant') {
                    // Store the original markdown for code extraction
                    lastAssistantMarkdown = safeMessage;
                    // Use markdown for assistant messages
                    content = marked.parse(safeMessage);
                } else {
                    // Regular HTML escaping for user and system messages
                    content = escapeHTML(safeMessage).replace(/\n/g, '<br>');
                }


                if (sender === 'user') {
                    messageElement.className = 'flex items-start space-x-3 justify-end animate-fadeIn'; // Added animation
                    messageElement.innerHTML = `
                        <div class="flex flex-col items-end space-y-1">
                            <div class="bg-primary-500 p-5 rounded-2xl rounded-tr-sm shadow-md max-w-2xl transform hover:shadow-lg transition-all duration-200">
                                <p class="text-white leading-relaxed">${content}</p>
                            </div>
                            <div class="flex items-center space-x-1 mr-2 text-xs text-slate-500">
                                <span>Sent</span>
                                <span class="material-symbols-outlined text-primary-500 text-sm">done</span>
                            </div>
                        </div>
                        <div class="w-10 h-10 bg-slate-300 rounded-full flex items-center justify-center flex-shrink-0 shadow-md">
                            <span class="material-symbols-outlined text-slate-600 text-sm">person</span>
                        </div>
                    `;
                } else if (sender === 'assistant') {
                    messageElement.className = 'flex items-start space-x-3 animate-fadeIn'; // Added animation
                    messageElement.innerHTML = `
                        <div class="w-10 h-10 bg-gradient-to-r from-primary-500 to-primary-600 rounded-full flex items-center justify-center flex-shrink-0 shadow-md shadow-primary-200/30">
                            <span class="material-symbols-outlined text-white text-sm">smart_toy</span>
                        </div>
                        <div class="bg-white p-5 rounded-2xl rounded-tl-sm shadow-md border border-slate-100 max-w-2xl transform hover:shadow-lg transition-all duration-200">
                            <div class="text-slate-700 leading-relaxed font-medium markdown-content">${content}</div>
                        </div>
                    `;
                } else { // System message (e.g., file upload status)
                     messageElement.className = 'flex justify-center animate-fadeIn'; // Added animation
                     messageElement.innerHTML = `
                        <div class="text-center max-w-md bg-slate-100 p-3 rounded-lg shadow-sm border border-slate-200 text-sm text-slate-600">
                           ${content}
                        </div>`;
                }
                chatContainer.appendChild(messageElement);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                // Return the content holding div for streaming/updates
                return messageElement.querySelector('.markdown-content') || messageElement.querySelector('.leading-relaxed') || messageElement.querySelector('.text-slate-600');
            }
            
            function showTypingIndicator() {
                if (!typingIndicatorInstance) {
                    typingIndicatorInstance = typingIndicatorTemplate.cloneNode(true);
                    typingIndicatorInstance.removeAttribute('id');
                    typingIndicatorInstance.style.display = 'flex';
                    chatContainer.appendChild(typingIndicatorInstance);
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }

            function hideTypingIndicator() {
                if (typingIndicatorInstance) {
                    typingIndicatorInstance.remove();
                    typingIndicatorInstance = null;
                }
            }

            async function sendMessage() {
                const messageText = messageInput.value.trim();
                if (!messageText) return;

                addMessageToChat(messageText, 'user');
                messageInput.value = '';
                messageInput.style.height = '60px'; // Reset height
                showTypingIndicator();

                try {
                    const response = await fetch('/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: messageText }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: "Unknown server error" }));
                        
                        if (response.status === 429) {
                            // Rate limit error
                            const waitTime = errorData.wait_time || 60;
                            hideTypingIndicator();
                            addMessageToChat(`⚠️ ${errorData.error || 'Rate limit exceeded'}`, 'system');
                            return;
                        }
                        
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    }
                    
                    hideTypingIndicator();
                    const aiMessageContentElement = addMessageToChat('', 'assistant'); // Add empty bubble
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let fullResponse = "";

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value, { stream: true });
                        fullResponse += chunk;
                        if(aiMessageContentElement) { // Check if element exists
                           // Store the markdown and render it
                           lastAssistantMarkdown = fullResponse;
                           aiMessageContentElement.innerHTML = marked.parse(fullResponse);
                        }
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }

                } catch (error) {
                    console.error('Error sending message:', error);
                    hideTypingIndicator();
                    addMessageToChat(`Sorry, I encountered an error: ${error.message}`, 'assistant');
                }
            }

            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keydown', (event) => {
                if ((event.metaKey || event.ctrlKey) && event.key === 'Enter' && !event.shiftKey) { // Ensure Shift+Enter still allows new line
                    event.preventDefault();
                    sendMessage();
                }
            });

            messageInput.addEventListener('input', () => {
                messageInput.style.height = 'auto'; 
                const maxHeight = 200; // Max height for textarea
                if (messageInput.scrollHeight <= maxHeight) {
                    messageInput.style.height = (messageInput.scrollHeight) + 'px';
                    messageInput.style.overflowY = 'hidden';
                } else {
                    messageInput.style.height = maxHeight + 'px';
                    messageInput.style.overflowY = 'auto';
                }
            });


            attachFileButton.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                addMessageToChat(`Processing ${escapeHTML(file.name)}...`, 'system');
                
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData,
                    });
                    const result = await response.json();
                    
                    if (response.ok) {
                        const fileName = result.filename || file.name;
                        const originalFormat = result.original_format || 'Unknown';
                        const convertedFormat = result.converted_format || 'JSONL';
                        addMessageToChat(`📁 <strong>${escapeHTML(fileName)}</strong><br>✅ ${escapeHTML(result.message)}<br><small>📄 ${originalFormat} → ${convertedFormat} | ${result.file_size} bytes</small>`, 'system', true);
                    } else {
                        addMessageToChat(`❌ Error: ${escapeHTML(result.error || 'File processing failed.')}`, 'system');
                    }
                } catch (error) {
                    console.error('Error processing file:', error);
                    addMessageToChat('❌ Error processing file. Please check the console.', 'system');
                }
                fileInput.value = ''; // Reset file input
            });

            // --- Code Execution ---
            const codeExecuteButton = document.getElementById('code-execute-button');
            let lastDetectedCode = null;
            
            codeExecuteButton.addEventListener('click', () => {
                executeDetectedCode();
            });

            // Store the original markdown content for each message
            let lastAssistantMarkdown = '';

            function detectCodeInLastMessage() {
                // First try to extract from the stored markdown
                if (lastAssistantMarkdown) {
                    const codeBlockRegex = /```(\w+)?\s*([\s\S]*?)```/g;
                    let match;
                    let lastCodeBlock = null;
                    
                    while ((match = codeBlockRegex.exec(lastAssistantMarkdown)) !== null) {
                        const language = match[1] || 'python';
                        const code = match[2].trim();
                        
                        lastCodeBlock = {
                            code: code,
                            language: language.toLowerCase()
                        };
                    }
                    
                    if (lastCodeBlock) {
                        return lastCodeBlock;
                    }
                }
                
                // Fallback: Find the last assistant message
                const assistantMessages = chatContainer.querySelectorAll('.markdown-content');
                if (assistantMessages.length === 0) return null;
                
                const lastMessage = assistantMessages[assistantMessages.length - 1];
                
                // Try to find code blocks in <pre><code> tags
                const codeBlocks = lastMessage.querySelectorAll('pre code');
                
                if (codeBlocks.length > 0) {
                    for (let i = codeBlocks.length - 1; i >= 0; i--) {
                        const codeBlock = codeBlocks[i];
                        const code = codeBlock.textContent;
                        
                        // Try to detect language from class or content
                        let language = 'python';
                        
                        if (codeBlock.className.includes('language-python') || code.includes('import ') || code.includes('plt.') || code.includes('numpy') || code.includes('pandas')) {
                            language = 'python';
                        } else if (codeBlock.className.includes('language-latex') || code.includes('\\documentclass') || code.includes('\\begin{document}')) {
                            language = 'latex';
                        } else if (codeBlock.className.includes('language-manim') || code.includes('from manim import') || code.includes('Scene') || code.includes('self.play')) {
                            language = 'manim';
                        }
                        
                        return {
                            code: code,
                            language: language
                        };
                    }
                }
                
                return null;
            }

            function executeDetectedCode() {
                const detectedCode = detectCodeInLastMessage();
                
                if (!detectedCode) {
                    addMessageToChat('❌ No executable code found in the last message. Please ask the AI to provide code first.', 'system');
                    return;
                }
                
                // Debug: Log the detected code
                console.log('Detected code:', detectedCode);
                console.log('Code length:', detectedCode.code.length);
                console.log('First 100 chars:', detectedCode.code.substring(0, 100));
                
                // Show execution message
                addMessageToChat(`🔄 Executing ${detectedCode.language} code...`, 'system');
                
                // Execute the code
                executeCode(detectedCode.code, detectedCode.language);
            }

            async function executeCode(code, executionType) {
                try {
                    const response = await fetch('/execute_code', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            code: code,
                            type: executionType
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        // The result is already added to chat by the backend
                        console.log('Code execution completed:', result);
                        
                        // If files were generated, add download links
                        if (result.output_files && result.output_files.length > 0) {
                            let linksMessage = '📁 **Generated Files:**\n';
                            result.output_files.forEach(file => {
                                const fileSize = (file.size / 1024).toFixed(1);
                                linksMessage += `- [📄 ${file.original_name}](${file.path}) (${fileSize} KB)\n`;
                            });
                            
                            // Add links message to chat
                            setTimeout(() => {
                                addMessageToChat(linksMessage, 'assistant');
                            }, 500);
                        }
                    } else {
                        addMessageToChat(`❌ Execution failed: ${escapeHTML(result.error)}`, 'system');
                    }
                } catch (error) {
                    console.error('Error executing code:', error);
                    addMessageToChat('❌ Error executing code. Please check the console.', 'system');
                }
            }

            // --- Sidebar Button Event Listeners ---
            if (newChatButton) {
                newChatButton.addEventListener('click', async () => {
                    // Show loading state
                    newChatButton.disabled = true;
                    newChatButton.innerHTML = '<span class="material-symbols-outlined text-white">hourglass_empty</span><span>Starting...</span>';
                    
                    try {
                        const response = await fetch('/reset_chat', { 
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            // Clear the chat container immediately
                            chatContainer.innerHTML = initialWelcomeElementHTML + initialCapabilitiesElementHTML;
                            messageInput.value = '';
                            messageInput.style.height = '60px';
                            
                            // Show success message
                            addMessageToChat("✅ New chat started!", 'system');
                            
                            // Reload to update chat history sidebar
                            setTimeout(() => {
                                location.reload();
                            }, 500);
                        } else {
                            console.error('Failed to start new chat:', result.message);
                            addMessageToChat(`❌ Failed to start new chat: ${result.message}`, 'system');
                        }
                    } catch (error) {
                        console.error('Error starting new chat:', error);
                        addMessageToChat("❌ Error starting new chat. Please try again.", 'system');
                    } finally {
                        // Restore button state
                        newChatButton.disabled = false;
                        newChatButton.innerHTML = '<span class="material-symbols-outlined text-white">add</span><span>New Chat</span>';
                    }
                });
            }

            function featureNotImplemented(featureName) {
                console.log(`${featureName} button clicked - feature not yet implemented.`);
                alert(`${featureName} is not yet implemented.`);
                addMessageToChat(`${featureName} feature is coming soon!`, 'system');
            }

            // Chat History Management
            function initializeChatHistory() {
                const chatItems = document.querySelectorAll('.chat-item');
                const renameChatBtns = document.querySelectorAll('.rename-chat-btn');
                const deleteChatBtns = document.querySelectorAll('.delete-chat-btn');

                // Load chat functionality
                chatItems.forEach(item => {
                    item.addEventListener('click', async (e) => {
                        if (e.target.closest('.rename-chat-btn') || e.target.closest('.delete-chat-btn')) {
                            return; // Don't load chat if clicking rename/delete buttons
                        }
                        
                        const chatId = item.dataset.chatId;
                        if (!chatId) {
                            console.error('No chat ID found');
                            return;
                        }
                        
                        // Show loading state
                        item.style.opacity = '0.5';
                        
                        try {
                            const response = await fetch(`/load_chat/${chatId}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                }
                            });
                            
                            const result = await response.json();
                            
                            if (response.ok) {
                                // Successfully loaded chat - reload page to show the loaded messages
                                window.location.reload();
                            } else {
                                console.error('Failed to load chat:', result.message);
                                addMessageToChat(`❌ Failed to load chat: ${result.message}`, 'system');
                            }
                        } catch (error) {
                            console.error('Error loading chat:', error);
                            addMessageToChat('❌ Error loading chat. Please try again.', 'system');
                        } finally {
                            item.style.opacity = '1';
                        }
                    });
                });

                // Delete chat functionality
                deleteChatBtns.forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        
                        if (!confirm('Are you sure you want to delete this chat?')) {
                            return;
                        }
                        
                        const chatId = btn.dataset.chatId;
                        if (!chatId) {
                            console.error('No chat ID found for delete');
                            return;
                        }
                        
                        try {
                            const response = await fetch(`/delete_chat/${chatId}`, {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json',
                                }
                            });
                            
                            const result = await response.json();
                            
                            if (response.ok) {
                                // Remove the chat item from DOM immediately
                                btn.closest('.chat-item').remove();
                                addMessageToChat('✅ Chat deleted successfully', 'system');
                            } else {
                                console.error('Failed to delete chat:', result.message);
                                addMessageToChat(`❌ Failed to delete chat: ${result.message}`, 'system');
                            }
                        } catch (error) {
                            console.error('Error deleting chat:', error);
                            addMessageToChat('❌ Error deleting chat. Please try again.', 'system');
                        }
                    });
                });

                // Rename chat functionality
                renameChatBtns.forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        
                        const chatId = btn.dataset.chatId;
                        const chatItem = btn.closest('.chat-item');
                        const nameElement = chatItem.querySelector('p');
                        const currentName = nameElement.textContent.trim();
                        
                        const newName = prompt('Enter new chat name:', currentName);
                        
                        if (!newName || newName.trim() === currentName) {
                            return;
                        }
                        
                        try {
                            const response = await fetch(`/rename_chat/${chatId}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ name: newName.trim() })
                            });
                            
                            const result = await response.json();
                            
                            if (response.ok) {
                                // Update the name in DOM immediately
                                nameElement.textContent = newName.trim();
                                addMessageToChat('✅ Chat renamed successfully', 'system');
                            } else {
                                console.error('Failed to rename chat:', result.message);
                                addMessageToChat(`❌ Failed to rename chat: ${result.message}`, 'system');
                            }
                        } catch (error) {
                            console.error('Error renaming chat:', error);
                            addMessageToChat('❌ Error renaming chat. Please try again.', 'system');
                        }
                    });
                });
            }

            // Initialize chat history
            initializeChatHistory();


             // Add a simple fade-in animation for messages (optional)
            const style = document.createElement('style');
            style.innerHTML = `
                @keyframes fadeIn {
                    from { opacity: 0; transform: translateY(10px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                .animate-fadeIn {
                    animation: fadeIn 0.3s ease-out;
                }
            `;
            document.head.appendChild(style);

        </script>
    </body>
</html>